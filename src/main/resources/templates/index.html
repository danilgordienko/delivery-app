<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Delivery App</title>

    <style>
        body { font-family: Arial; padding:20px; }
        section { border:1px solid #ccc; padding:15px; margin-bottom:20px; }
        table { border-collapse: collapse; width:100%; margin-top:10px;}
        th, td { border:1px solid #ddd; padding:6px;}
        button { margin-top:10px; }
    </style>

</head>
<body>

<h1>Приёмка поставок</h1>

<section>
    <h2>Новая поставка</h2>

    <label>Поставщик:</label>
    <select id="providerSelect"></select>

    <br><br>

    <label>Дата поставки:</label>
    <input type="date" id="deliveryDate">

    <h3>Продукты</h3>

    <table id="productsTable">
        <thead>
        <tr>
            <th>Продукт</th>
            <th>Вес</th>
            <th></th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button onclick="addProductRow()">Добавить продукт</button>
    <br>
    <button onclick="submitDelivery()">Сохранить поставку</button>

</section>

<section>

    <h2>Отчёт</h2>

    <label>Начало:</label>
    <input type="date" id="startDate">

    <label>Конец:</label>
    <input type="date" id="endDate">

    <button onclick="loadReport()">Получить отчёт</button>

    <div id="reportResult"></div>

</section>

<script>

    let products = [];

    function renderReport(data){

        const container = document.getElementById('reportResult');
        container.innerHTML = '';

        const report = data.report;

        Object.entries(report).forEach(([provider, info]) => {

            const block = document.createElement('div');
            block.style.border = '1px solid #999';
            block.style.padding = '10px';
            block.style.marginBottom = '15px';

            const title = document.createElement('h3');
            title.textContent = provider;

            const totals = document.createElement('p');
            totals.textContent =
                `Вес: ${info.totalWeight} кг | Стоимость: ${info.totalCost}`;

            const table = document.createElement('table');

            table.innerHTML = `
            <thead>
                <tr>
                    <th>Продукт</th>
                    <th>Стоимость</th>
                    <th>Вес</th>
                </tr>
            </thead>
        `;

            const tbody = document.createElement('tbody');

            info.products.forEach(item => {

                const tr = document.createElement('tr');

                tr.innerHTML = `
                <td>${item.product.name}</td>
                <td>${item.product.price}</td>
                <td>${item.weight}</td>
            `;

                tbody.appendChild(tr);
            });

            table.appendChild(tbody);

            block.appendChild(title);
            block.appendChild(totals);
            block.appendChild(table);

            container.appendChild(block);
        });
    }



    async function loadProviders(){
        const res = await fetch('http://localhost:8081/api/providers');
        const providers = await res.json();

        console.log("providers:", providers);

        const select = document.getElementById('providerSelect');

        providers.forEach(p=>{
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            select.appendChild(opt);
        });
    }


    async function loadProducts(){
        const res = await fetch('http://localhost:8081/api/products');
        products = await res.json();
    }

    function addProductRow(){

        const tbody = document.querySelector('#productsTable tbody');
        const tr = document.createElement('tr');

        const productSelect = document.createElement('select');

        products.forEach(p=>{
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name + " ("+p.price+")";
            productSelect.appendChild(opt);
        });

        tr.innerHTML = `
        <td></td>
        <td><input type="number" step="0.1"></td>
        <td><button onclick="this.closest('tr').remove()">Удалить</button></td>
    `;

        tr.children[0].appendChild(productSelect);

        tbody.appendChild(tr);
    }

    async function submitDelivery(){

        const providerId = document.getElementById('providerSelect').value;
        const deliveryDate = document.getElementById('deliveryDate').value;

        const rows = document.querySelectorAll('#productsTable tbody tr');

        const deliveryProducts = [];

        rows.forEach(r=>{
            const productId = r.querySelector('select').value;
            const weight = r.querySelector('input').value;

            deliveryProducts.push({
                productId: Number(productId),
                weight: Number(weight)
            });
        });

        const payload = {
            providerId: Number(providerId),
            deliveryDate: deliveryDate,
            products: deliveryProducts
        };

        await fetch('http://localhost:8081/api/deliveries',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(payload)
        });

        alert('Поставка сохранена');
    }

    async function loadReport(){

        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        const res = await fetch(
            `http://localhost:8081/api/deliveries/report?startDate=${startDate}&endDate=${endDate}`
        );

        const data = await res.json();

        renderReport(data);
    }



    document.addEventListener('DOMContentLoaded', async () => {
        await loadProviders();
        await loadProducts();
    });


</script>

</body>
</html>
